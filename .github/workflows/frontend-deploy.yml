# name: Frontend CI/CD (build â†’ rsync dist)

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - frontend/**
#   workflow_dispatch:

# jobs:
#   frontend-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       - name: Install frontend dependencies
#         working-directory: frontend
#         run: npm install

#       - name: Build frontend
#         working-directory: frontend
#         run: npm run build

#       # ğŸ” SSH setup
#       - name: Setup SSH
#         run: |
#           mkdir -p ~/.ssh
#           echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
#           chmod 600 ~/.ssh/id_rsa
#           ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

#       # ğŸ§¹ Clean dist on EC2
#       - name: Clean dist on EC2
#         run: |
#           ssh ec2-user@${{ secrets.EC2_HOST }} \
#           "sudo rm -rf /home/ec2-user/project/frontend/dist && \
#            sudo mkdir -p /home/ec2-user/project/frontend/dist && \
#            sudo chown -R ec2-user:ec2-user /home/ec2-user/project/frontend"

#       # ğŸš€ COPY FILES (THIS IS THE CRITICAL STEP)
#       - name: Rsync dist to EC2
#         run: |
#           rsync -avz --delete frontend/dist/ \
#           ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/project/frontend/dist/

#       # ğŸ” Reload nginx
#       - name: Reload nginx
#         run: |
#           ssh ec2-user@${{ secrets.EC2_HOST }} \
#           "sudo nginx -t && sudo systemctl reload nginx"


name: Frontend CI/CD (build â†’ rsync dist)

on:
  push:
    branches:
      - main
    paths:
      - frontend/**
  workflow_dispatch:

jobs:
  frontend-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      # ğŸ” SSH setup
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # ğŸš€ Rsync dist to EC2 (clean & safe)
      - name: Deploy dist to EC2
        run: |
          rsync -avz --delete \
          frontend/dist/ \
          ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/project/Zero-Fund/frontend/dist/

      # ğŸ” Reload nginx
      - name: Reload nginx
        run: |
          ssh ec2-user@${{ secrets.EC2_HOST }} \
          "sudo nginx -t && sudo systemctl reload nginx"
